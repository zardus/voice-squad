# Usage:
#   docker compose up --build
#   SQUAD_CAPTAIN=codex docker compose up --build
#
# Required env vars: ANTHROPIC_API_KEY, OPENAI_API_KEY
# Optional: GH_TOKEN, SQUAD_CAPTAIN (default: claude), VOICE_TOKEN (auto-generated if not set)

services:
  workspace:
    build:
      context: src
      dockerfile: Dockerfile.workspace
    privileged: true
    stdin_open: true
    tty: true
    volumes:
      - ./home:/home/ubuntu
      - tmux-socket:/run/tmux
    environment:
      - ANTHROPIC_API_KEY
      - OPENAI_API_KEY
      - GH_TOKEN
      - SQUAD_CAPTAIN=${SQUAD_CAPTAIN:-claude}
      - VOICE_TOKEN
      - VOICE_SERVER_URL=http://voice-server:3000
      - COMPOSE_MODE=1
      - TMUX_TMPDIR=/run/tmux
    healthcheck:
      test: ["CMD-SHELL", "tmux has-session -t captain 2>/dev/null"]
      interval: 5s
      timeout: 3s
      retries: 120
      start_period: 10s

  voice-server:
    build:
      context: src
      dockerfile: Dockerfile.voice
    depends_on:
      workspace:
        condition: service_healthy
    volumes:
      - ./home:/home/ubuntu
      - tmux-socket:/run/tmux
    environment:
      - OPENAI_API_KEY
      - ANTHROPIC_API_KEY
      - VOICE_TOKEN
      - SQUAD_CAPTAIN=${SQUAD_CAPTAIN:-claude}
      - TMUX_TMPDIR=/run/tmux
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:3000/ || exit 1"]
      interval: 15s
      timeout: 3s
      retries: 3
      start_period: 15s
    restart: unless-stopped

  pane-monitor:
    build:
      context: src
      dockerfile: Dockerfile.pane-monitor
    depends_on:
      workspace:
        condition: service_healthy
    volumes:
      - tmux-socket:/run/tmux
    environment:
      - TMUX_TMPDIR=/run/tmux

volumes:
  tmux-socket:
