# Usage:
#   docker compose up --build
#   SQUAD_CAPTAIN=codex docker compose up --build
#
# Required env vars: ANTHROPIC_API_KEY, OPENAI_API_KEY
# Optional: GH_TOKEN, SQUAD_CAPTAIN (default: claude), VOICE_TOKEN (auto-generated if not set)

services:
  workspace:
    build:
      context: src/workspace
    privileged: true
    stdin_open: true
    tty: true
    volumes:
      - ./home:/home/ubuntu
      - workspace-tmux:/run/workspace-tmux
    environment:
      - ANTHROPIC_API_KEY
      - OPENAI_API_KEY
      - GH_TOKEN
      - TMUX_TMPDIR=/run/workspace-tmux
    healthcheck:
      test: ["CMD-SHELL", "cat /proc/1/comm | grep -q sleep"]
      interval: 5s
      timeout: 3s
      retries: 120
      start_period: 10s

  captain:
    build:
      context: src/captain
    depends_on:
      workspace:
        condition: service_healthy
    volumes:
      - ./home:/home/ubuntu
      - captain-tmux:/run/captain-tmux
      - workspace-tmux:/run/workspace-tmux
    environment:
      - ANTHROPIC_API_KEY
      - OPENAI_API_KEY
      - GH_TOKEN
      - SQUAD_CAPTAIN=${SQUAD_CAPTAIN:-claude}
      - VOICE_TOKEN
      - VOICE_SERVER_URL=http://voice-server:3000
      - TMUX_TMPDIR=/run/workspace-tmux
      - CAPTAIN_TMUX_SOCKET=/run/captain-tmux/default
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "tmux -S /run/captain-tmux/default has-session -t captain 2>/dev/null"]
      interval: 5s
      timeout: 3s
      retries: 120
      start_period: 10s

  voice-server:
    build:
      context: src/voice-server
      args:
        GIT_COMMIT: ${GIT_COMMIT:-unknown}
    depends_on:
      captain:
        condition: service_healthy
    volumes:
      - ./home:/home/ubuntu
      - captain-tmux:/run/captain-tmux
      - workspace-tmux:/run/workspace-tmux
    environment:
      - OPENAI_API_KEY
      - ANTHROPIC_API_KEY
      - VOICE_TOKEN
      - SQUAD_CAPTAIN=${SQUAD_CAPTAIN:-claude}
      - CAPTAIN_TMUX_SOCKET=/run/captain-tmux/default
      - WORKSPACE_TMUX_SOCKET=/run/workspace-tmux/default
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:3000/ || exit 1"]
      interval: 15s
      timeout: 3s
      retries: 3
      start_period: 15s
    restart: unless-stopped

  tunnel:
    build:
      context: src/tunnel
    depends_on:
      voice-server:
        condition: service_healthy
    volumes:
      - ./home:/home/ubuntu
    environment:
      - VOICE_TOKEN
      - VOICE_SERVER_ORIGIN=http://voice-server:3000

  pane-monitor:
    build:
      context: src/pane-monitor
    depends_on:
      captain:
        condition: service_healthy
    volumes:
      - captain-tmux:/run/captain-tmux
      - workspace-tmux:/run/workspace-tmux
    environment:
      - CAPTAIN_TMUX_SOCKET=/run/captain-tmux/default
      - WORKSPACE_TMUX_SOCKET=/run/workspace-tmux/default

volumes:
  captain-tmux:
  workspace-tmux:
