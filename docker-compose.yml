# Usage:
#   docker compose up --build
#   SQUAD_CAPTAIN=codex docker compose up --build
#
# Required env vars: ANTHROPIC_API_KEY, OPENAI_API_KEY
# Optional: GH_TOKEN, SQUAD_CAPTAIN (default: claude), VOICE_TOKEN (auto-generated by voice-server if not set)

services:
  workspace:
    build:
      context: src/workspace
    privileged: true
    stdin_open: true
    tty: true
    volumes:
      - ./home:/home/ubuntu
      - sockets:/run/squad-sockets
    environment:
      - ANTHROPIC_API_KEY
      - OPENAI_API_KEY
      - GH_TOKEN
      - TMUX_TMPDIR=/run/squad-sockets/workspace-tmux
      - WORKSPACE_TMUX_SOCKET=/run/squad-sockets/workspace-tmux/default
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep -q [t]mux"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s

  captain:
    build:
      context: src/captain
    depends_on:
      workspace:
        condition: service_healthy
    volumes:
      - ./home:/home/ubuntu
      - sockets:/run/squad-sockets
    environment:
      - ANTHROPIC_API_KEY
      - OPENAI_API_KEY
      - GH_TOKEN
      - SQUAD_CAPTAIN=${SQUAD_CAPTAIN:-claude}
      - TMUX_TMPDIR=/run/squad-sockets/workspace-tmux
      - CAPTAIN_TMUX_SOCKET=/run/squad-sockets/captain-tmux/default
      - WORKSPACE_TMUX_SOCKET=/run/squad-sockets/workspace-tmux/default
      - SPEAK_SOCKET_PATH=/run/squad-sockets/speak.sock
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "tmux -S /run/squad-sockets/captain-tmux/default has-session -t captain 2>/dev/null"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s

  voice-server:
    build:
      context: src/voice-server
      args:
        GIT_COMMIT: ${GIT_COMMIT:-unknown}
    depends_on:
      captain:
        condition: service_healthy
    volumes:
      - ./home:/home/ubuntu
      - sockets:/run/squad-sockets
    environment:
      - OPENAI_API_KEY
      - ANTHROPIC_API_KEY
      - VOICE_TOKEN
      - SQUAD_CAPTAIN=${SQUAD_CAPTAIN:-claude}
      - CAPTAIN_TMUX_SOCKET=/run/squad-sockets/captain-tmux/default
      - WORKSPACE_TMUX_SOCKET=/run/squad-sockets/workspace-tmux/default
      - SPEAK_SOCKET_PATH=/run/squad-sockets/speak.sock
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:3000/ || exit 1"]
      interval: 15s
      timeout: 3s
      retries: 3
      start_period: 15s
    restart: unless-stopped

  tunnel:
    build:
      context: src/tunnel
    depends_on:
      voice-server:
        condition: service_healthy
    volumes:
      - ./home:/home/ubuntu
    environment:
      - VOICE_TOKEN
      - VOICE_SERVER_ORIGIN=http://voice-server:3000

  pane-monitor:
    build:
      context: src/pane-monitor
    depends_on:
      captain:
        condition: service_healthy
    volumes:
      - sockets:/run/squad-sockets
    environment:
      - CAPTAIN_TMUX_SOCKET=/run/squad-sockets/captain-tmux/default
      - WORKSPACE_TMUX_SOCKET=/run/squad-sockets/workspace-tmux/default
      - HEARTBEAT_INTERVAL_SECONDS=${HEARTBEAT_INTERVAL_SECONDS:-900}
    restart: unless-stopped

volumes:
  sockets:
