# Lightweight test-runner: Playwright + Chromium + tmux client.
# The voice server and tmux sessions run in separate containers
# (see docker-compose.test.yml).

FROM ubuntu:24.04

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y \
    curl \
    tmux \
    ca-certificates \
    gnupg \
    procps \
    sudo \
    socat \
    python3 \
    && rm -rf /var/lib/apt/lists/*

# Node.js 20
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

# Set up ubuntu user
RUN usermod -aG sudo ubuntu \
    && echo "ubuntu ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Tmux socket directories for cross-container sharing
RUN mkdir -p /run/captain-tmux /run/workspace-tmux \
    && chown ubuntu:ubuntu /run/captain-tmux /run/workspace-tmux

# ── Scripts under test ──────────────────────────────────────
# show-qr.js + its qrcode-terminal dependency
RUN mkdir -p /opt/squad/voice && cd /opt/squad/voice && npm install --save qrcode-terminal
COPY src/tunnel/show-qr.js /opt/squad/voice/show-qr.js
COPY src/captain/restart-captain.sh /opt/squad/restart-captain.sh
COPY src/pane-monitor/pane-monitor.sh /opt/squad/pane-monitor.sh
COPY src/captain/switch-account.sh /opt/tests/src/captain/switch-account.sh
COPY src/fuse-auth-proxy/fuse-auth-register.sh /opt/squad/fuse-auth-proxy/fuse-auth-register.sh
RUN chmod +x /opt/squad/restart-captain.sh /opt/squad/pane-monitor.sh \
    /opt/squad/fuse-auth-proxy/fuse-auth-register.sh

# ── Switch to ubuntu for npm/playwright install ─────────────
# Avoids a slow chown -R over hundreds of MB of Chromium binaries.
RUN mkdir -p /opt/tests /opt/pw-browsers \
    && chown ubuntu:ubuntu /opt/tests /opt/pw-browsers

USER ubuntu

# ── Test suite ───────────────────────────────────────────────
COPY --chown=ubuntu:ubuntu tests/package.json tests/playwright.config.js /opt/tests/

WORKDIR /opt/tests

ENV PLAYWRIGHT_BROWSERS_PATH=/opt/pw-browsers

RUN npm install \
    && npx playwright install chromium

# Playwright install --with-deps needs sudo for apt
RUN sudo npx playwright install-deps chromium

# Copy tests after Playwright install so changing tests doesn't invalidate the heavy browser install layer.
COPY --chown=ubuntu:ubuntu tests/*.spec.js /opt/tests/tests/
COPY --chown=ubuntu:ubuntu tests/helpers/ /opt/tests/tests/helpers/

# ── Test entrypoint ──────────────────────────────────────────
COPY tests/entrypoint-test.sh /entrypoint-test.sh

WORKDIR /home/ubuntu

ENTRYPOINT ["/entrypoint-test.sh"]
