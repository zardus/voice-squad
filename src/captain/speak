#!/bin/bash
# speak â€” Send text to the voice interface for TTS playback
# Usage: speak "Workers are finishing up the auth module"
#
# Waits for the speak socket to become available (voice-server may still be
# starting or restarting). Retries with backoff up to SPEAK_TIMEOUT seconds.

if [ -z "$1" ]; then
  echo "Usage: speak \"text to speak\"" >&2
  exit 1
fi

SPEAK_SOCKET="${SPEAK_SOCKET_PATH:-/run/squad-sockets/speak.sock}"
SPEAK_TIMEOUT="${SPEAK_TIMEOUT:-10}"

# Wait for the socket to appear (handles startup race and voice-server restarts).
# Track wall-clock elapsed time via SECONDS so the timeout is accurate.
SECONDS=0
attempts=0
while [ ! -S "$SPEAK_SOCKET" ]; do
  if [ "$SECONDS" -ge "$SPEAK_TIMEOUT" ]; then
    echo "Error: speak socket not available at $SPEAK_SOCKET after ${SPEAK_TIMEOUT}s" >&2
    exit 1
  fi
  # Back off: 0.2s, 0.2s, 0.5s, then 1s thereafter
  if [ "$attempts" -ge 3 ]; then
    sleep 1
  elif [ "$attempts" -ge 2 ]; then
    sleep 0.5
  else
    sleep 0.2
  fi
  attempts=$((attempts + 1))
done

curl --silent --show-error --fail --unix-socket "$SPEAK_SOCKET" \
  -X POST "http://localhost/speak" \
  -H "Content-Type: application/json" \
  -d "{\"text\": $(printf '%s' "$1" | jq -Rs .)}" \
  > /dev/null
