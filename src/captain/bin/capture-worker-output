#!/bin/bash
# capture-worker-output â€” Capture recent output from a worker pane
# Usage: capture-worker-output TASK_NAME [LINE_COUNT]

set -euo pipefail

TASK_NAME="${1:?Usage: capture-worker-output TASK_NAME [LINE_COUNT]}"
LINE_COUNT="${2:-50}"

SOCKET="${WORKSPACE_TMUX_SOCKET:?WORKSPACE_TMUX_SOCKET not set}"

if ! tmux -S "$SOCKET" has-session -t "$TASK_NAME" 2>/dev/null; then
    echo "ERROR: No worker session found with name '$TASK_NAME'" >&2
    exit 1
fi

PANE_INFO=$(tmux -S "$SOCKET" list-panes -t "${TASK_NAME}:0" -F '#{pane_id} #{pane_current_command}' 2>/dev/null | head -1 || true)
PANE_ID=$(printf '%s\n' "$PANE_INFO" | awk '{print $1}')
CURRENT_CMD=$(printf '%s\n' "$PANE_INFO" | awk '{print $2}')

if [ -z "$PANE_ID" ]; then
    echo "ERROR: Worker '$TASK_NAME' has no pane at window 0" >&2
    exit 1
fi

case "$CURRENT_CMD" in
    claude|codex|node|npm) ;;
    *)
        echo "ERROR: Worker '$TASK_NAME' pane is running '$CURRENT_CMD', not an agent process." >&2
        exit 1
        ;;
esac

if ! [[ "$LINE_COUNT" =~ ^[0-9]+$ ]]; then
    echo "ERROR: LINE_COUNT must be a non-negative integer (got '$LINE_COUNT')" >&2
    exit 1
fi

tmux -S "$SOCKET" capture-pane -t "$PANE_ID" -p -S "-${LINE_COUNT}" \
    | perl -pe 's/\d+% context left/" " x length($&)/ge'
