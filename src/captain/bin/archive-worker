#!/bin/bash
# archive-worker — Archive a completed worker
# Usage: archive-worker TASK_NAME
# Reads summary from stdin → .summary, captures full pane → .log,
# moves .task to archived, kills the worker tmux session.

set -euo pipefail

TASK_NAME="${1:?Usage: archive-worker TASK_NAME}"

SOCKET="${WORKSPACE_TMUX_SOCKET:?WORKSPACE_TMUX_SOCKET not set}"
ARCHIVE_DIR="$HOME/captain/tasks/archived"
PENDING_DIR="$HOME/captain/tasks/pending"

mkdir -p "$ARCHIVE_DIR"

# Read summary from stdin
cat > "$ARCHIVE_DIR/${TASK_NAME}.summary"

if tmux -S "$SOCKET" has-session -t "$TASK_NAME" 2>/dev/null; then
    PANE_INFO=$(tmux -S "$SOCKET" list-panes -t "${TASK_NAME}:0" -F '#{pane_id} #{pane_current_command}' 2>/dev/null | head -1 || true)
    PANE_ID=$(printf '%s\n' "$PANE_INFO" | awk '{print $1}')
    CURRENT_CMD=$(printf '%s\n' "$PANE_INFO" | awk '{print $2}')

    if [ -z "$PANE_ID" ]; then
        echo "WARNING: Worker session '$TASK_NAME' has no pane at window 0" >&2
    elif [ "$CURRENT_CMD" = "claude" ] || [ "$CURRENT_CMD" = "codex" ] || [ "$CURRENT_CMD" = "node" ] || [ "$CURRENT_CMD" = "npm" ]; then
        # Capture full pane output
        tmux -S "$SOCKET" capture-pane -t "$PANE_ID" -p -S -10000 > "$ARCHIVE_DIR/${TASK_NAME}.log" 2>/dev/null || true
    else
        echo "WARNING: Worker '$TASK_NAME' pane is running '$CURRENT_CMD'; capturing output anyway." >&2
        tmux -S "$SOCKET" capture-pane -t "$PANE_ID" -p -S -10000 > "$ARCHIVE_DIR/${TASK_NAME}.log" 2>/dev/null || true
    fi

    tmux -S "$SOCKET" kill-session -t "$TASK_NAME" 2>/dev/null || true
else
    echo "WARNING: No active worker session found for '$TASK_NAME' (may have already exited)" >&2
fi

# Move task file to archived
if [ -f "$PENDING_DIR/${TASK_NAME}.task" ]; then
    mv "$PENDING_DIR/${TASK_NAME}.task" "$ARCHIVE_DIR/${TASK_NAME}.task"
fi

echo "Worker '$TASK_NAME' archived."
