#!/bin/bash
# archive-worker — Archive a completed worker
# Usage: archive-worker TASK_NAME
# Reads summary from stdin → .summary, captures full pane → .log,
# moves .task to archived, kills the tmux window.

set -euo pipefail

TASK_NAME="${1:?Usage: archive-worker TASK_NAME}"

SOCKET="${WORKSPACE_TMUX_SOCKET:?WORKSPACE_TMUX_SOCKET not set}"
ARCHIVE_DIR="$HOME/captain/tasks/archived"
PENDING_DIR="$HOME/captain/tasks/pending"

mkdir -p "$ARCHIVE_DIR"

# Read summary from stdin
cat > "$ARCHIVE_DIR/${TASK_NAME}.summary"

# Find pane by window name
PANE_ID=$(tmux -S "$SOCKET" list-panes -a -F '#{window_name} #{pane_id}' 2>/dev/null | grep "^${TASK_NAME} " | head -1 | awk '{print $2}')

if [ -n "$PANE_ID" ]; then
    # Capture full pane output
    tmux -S "$SOCKET" capture-pane -t "$PANE_ID" -p -S -10000 > "$ARCHIVE_DIR/${TASK_NAME}.log" 2>/dev/null || true

    # Find the window target (session:window_id) to kill it
    WINDOW_TARGET=$(tmux -S "$SOCKET" list-panes -a -F '#{window_name} #{session_name}:#{window_id}' 2>/dev/null | grep "^${TASK_NAME} " | head -1 | awk '{print $2}')
    if [ -n "$WINDOW_TARGET" ]; then
        tmux -S "$SOCKET" kill-window -t "$WINDOW_TARGET" 2>/dev/null || true
    fi
else
    echo "WARNING: No active worker pane found for '$TASK_NAME' (may have already exited)" >&2
fi

# Move task file to archived
if [ -f "$PENDING_DIR/${TASK_NAME}.task" ]; then
    mv "$PENDING_DIR/${TASK_NAME}.task" "$ARCHIVE_DIR/${TASK_NAME}.task"
fi

echo "Worker '$TASK_NAME' archived."
