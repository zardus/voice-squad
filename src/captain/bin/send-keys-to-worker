#!/bin/bash
# send-keys-to-worker â€” Send keystrokes to a worker pane
# Usage: send-keys-to-worker TASK_NAME KEYS...
# Safety-checks that the pane is running a known agent process before sending.

set -euo pipefail

TASK_NAME="${1:?Usage: send-keys-to-worker TASK_NAME KEYS...}"
shift

if [ $# -eq 0 ]; then
    echo "ERROR: No keys specified" >&2
    exit 1
fi

SOCKET="${WORKSPACE_TMUX_SOCKET:?WORKSPACE_TMUX_SOCKET not set}"

# Find pane by window name
PANE_ID=$(tmux -S "$SOCKET" list-panes -a -F '#{window_name} #{pane_id}' 2>/dev/null | grep "^${TASK_NAME} " | head -1 | awk '{print $2}')

if [ -z "$PANE_ID" ]; then
    echo "ERROR: No worker found with name '$TASK_NAME'" >&2
    exit 1
fi

# Safety check: verify the pane is running a known agent process
CURRENT_CMD=$(tmux -S "$SOCKET" list-panes -t "$PANE_ID" -F '#{pane_current_command}' 2>/dev/null || echo "")

case "$CURRENT_CMD" in
    claude|codex|node|npm) ;;
    *)
        echo "ERROR: Worker '$TASK_NAME' is running '$CURRENT_CMD', not an agent process. Refusing to send keys." >&2
        exit 1
        ;;
esac

tmux -S "$SOCKET" send-keys -t "$PANE_ID" "$@"
