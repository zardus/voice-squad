#!/bin/bash
# send-keys-to-worker â€” Send keystrokes to a worker pane
# Usage: send-keys-to-worker TASK_NAME KEYS...
# Safety-checks that the pane is running a known agent process before sending.

set -euo pipefail

TASK_NAME="${1:?Usage: send-keys-to-worker TASK_NAME KEYS...}"
shift

if [ $# -eq 0 ]; then
    echo "ERROR: No keys specified" >&2
    exit 1
fi

SOCKET="${WORKSPACE_TMUX_SOCKET:?WORKSPACE_TMUX_SOCKET not set}"

if ! tmux -S "$SOCKET" has-session -t "$TASK_NAME" 2>/dev/null; then
    echo "ERROR: No worker session found with name '$TASK_NAME'" >&2
    exit 1
fi

PANE_INFO=$(tmux -S "$SOCKET" list-panes -t "${TASK_NAME}:0" -F '#{pane_id} #{pane_current_command}' 2>/dev/null | head -1 || true)
PANE_ID=$(printf '%s\n' "$PANE_INFO" | awk '{print $1}')
CURRENT_CMD=$(printf '%s\n' "$PANE_INFO" | awk '{print $2}')

if [ -z "$PANE_ID" ]; then
    echo "ERROR: Worker '$TASK_NAME' has no pane at window 0" >&2
    exit 1
fi

# Safety check: verify the pane is running a known agent process
case "$CURRENT_CMD" in
    claude|codex|node|npm) ;;
    *)
        echo "ERROR: Worker '$TASK_NAME' is running '$CURRENT_CMD', not an agent process. Refusing to send keys." >&2
        exit 1
        ;;
esac

tmux -S "$SOCKET" send-keys -t "$PANE_ID" "$@"
