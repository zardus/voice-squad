# Test overrides â€” layered on top of docker-compose.yml.
#
# Usage (via test.sh):
#   docker compose -p voice-squad-test -f docker-compose.yml -f docker-compose.test.yml \
#     run --build --rm test-runner
#
# All real services run their real entrypoints with real API keys.
# The only override is swapping ./home for an ephemeral volume.

services:
  workspace:
    volumes:
      - test-home:/home/ubuntu
    environment:
      OPENAI_API_KEY: ${OPENAI_API_KEY:-test-openai-key}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-test-anthropic-key}

  captain:
    volumes:
      - test-home:/home/ubuntu
    environment:
      OPENAI_API_KEY: ${OPENAI_API_KEY:-test-openai-key}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-test-anthropic-key}

  voice-server:
    volumes:
      - test-home:/home/ubuntu
    environment:
      OPENAI_API_KEY: ${OPENAI_API_KEY:-test-openai-key}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-test-anthropic-key}

  tunnel:
    volumes:
      - test-home:/home/ubuntu

  test-runner:
    build:
      context: .
      dockerfile: tests/Dockerfile.test
    depends_on:
      voice-server:
        condition: service_healthy
      pane-monitor:
        condition: service_started
    volumes:
      - test-home:/home/ubuntu
      - captain-tmux:/run/captain-tmux
      - workspace-tmux:/run/workspace-tmux
    environment:
      - VOICE_TOKEN
      - TEST_INTEGRATION=1
      - TEST_CAPTAIN=${TEST_CAPTAIN:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-test-openai-key}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-test-anthropic-key}
      - CAPTAIN_TMUX_SOCKET=/run/captain-tmux/default
      - WORKSPACE_TMUX_SOCKET=/run/workspace-tmux/default

volumes:
  test-home:
