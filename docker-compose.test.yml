# Test overrides â€” layered on top of docker-compose.yml.
#
# Usage (via test.sh):
#   docker compose -p voice-squad-test -f docker-compose.yml -f docker-compose.test.yml \
#     run --build --rm test-runner
#
# All real services run their real entrypoints with real API keys.
# Overrides only swap ./home for an ephemeral volume, share PID/network
# namespaces so the test-runner can reach localhost:3000 and inspect
# processes, and disable the tunnel.

services:
  workspace:
    volumes:
      - test-home:/home/ubuntu

  captain:
    pid: "service:workspace"
    volumes:
      - test-home:/home/ubuntu

  voice-server:
    network_mode: "service:workspace"
    pid: "service:workspace"
    volumes:
      - test-home:/home/ubuntu

  tunnel:
    volumes:
      - test-home:/home/ubuntu

  pane-monitor:
    pid: "service:workspace"

  test-runner:
    build:
      context: .
      dockerfile: tests/Dockerfile.test
    network_mode: "service:workspace"
    pid: "service:workspace"
    depends_on:
      voice-server:
        condition: service_healthy
      pane-monitor:
        condition: service_started
    volumes:
      - test-home:/home/ubuntu
      - captain-tmux:/run/captain-tmux
      - workspace-tmux:/run/workspace-tmux
    environment:
      - VOICE_TOKEN
      - TEST_INTEGRATION=1
      - TEST_CAPTAIN=${TEST_CAPTAIN:-}
      - OPENAI_API_KEY
      - ANTHROPIC_API_KEY
      - CAPTAIN_TMUX_SOCKET=/run/captain-tmux/default
      - WORKSPACE_TMUX_SOCKET=/run/workspace-tmux/default

volumes:
  test-home:
