# Test stack: reuses real images with a lightweight test-runner.
#
# Usage (via test.sh):
#   docker compose -p voice-squad-test -f docker-compose.test.yml run --build --rm test-runner
#
# All services share the workspace PID/network namespace so localhost:3000,
# pgrep, and tmux commands work transparently from the test-runner.

services:
  workspace:
    build:
      context: src/workspace
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        set -e
        sudo mkdir -p /run/workspace-tmux && sudo chown ubuntu:ubuntu /run/workspace-tmux && sudo chmod 755 /run/workspace-tmux
        tmux -S /run/workspace-tmux/default new-session -d -s workspace -c /home/ubuntu
        mkdir -p /run/workspace-tmux/tmux-$(id -u)
        ln -sf /run/workspace-tmux/default /run/workspace-tmux/tmux-$(id -u)/default
        exec sleep infinity
    volumes:
      - test-home:/home/ubuntu
      - workspace-tmux:/run/workspace-tmux
    environment:
      - TMUX_TMPDIR=/run/workspace-tmux
    healthcheck:
      test: ["CMD-SHELL", "tmux -S /run/workspace-tmux/default has-session 2>/dev/null"]
      interval: 2s
      timeout: 3s
      retries: 30
      start_period: 3s

  captain:
    build:
      context: src/captain
    pid: "service:workspace"
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        set -e
        sudo mkdir -p /run/captain-tmux /run/workspace-tmux
        sudo chown ubuntu:ubuntu /run/captain-tmux /run/workspace-tmux
        sudo chmod 755 /run/captain-tmux /run/workspace-tmux
        mkdir -p /home/ubuntu/captain/archive/summaries
        mkdir -p /home/ubuntu/captain/task-definitions/pending
        mkdir -p /home/ubuntu/captain/task-definitions/archived
        cp /opt/squad/captain/instructions.md /home/ubuntu/captain/CLAUDE.md
        printf 'OPENAI_API_KEY="%s"\nANTHROPIC_API_KEY="%s"\n' "$$OPENAI_API_KEY" "$$ANTHROPIC_API_KEY" > /home/ubuntu/env
        echo "$$VOICE_TOKEN" > /home/ubuntu/.voice-token
        tmux -S /run/captain-tmux/default new-session -d -s captain -c /home/ubuntu
        exec sleep infinity
    depends_on:
      workspace:
        condition: service_healthy
    volumes:
      - test-home:/home/ubuntu
      - captain-tmux:/run/captain-tmux
      - workspace-tmux:/run/workspace-tmux
    environment:
      - VOICE_TOKEN=test-token-for-ci
      - OPENAI_API_KEY=${OPENAI_API_KEY:-sk-test-dummy}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-sk-ant-test-dummy}
      - CAPTAIN_TMUX_SOCKET=/run/captain-tmux/default
      - TMUX_TMPDIR=/run/workspace-tmux
    healthcheck:
      test: ["CMD-SHELL", "tmux -S /run/captain-tmux/default has-session -t captain 2>/dev/null"]
      interval: 2s
      timeout: 3s
      retries: 30
      start_period: 3s

  voice-server:
    build:
      context: src/voice-server
    network_mode: "service:workspace"
    pid: "service:workspace"
    depends_on:
      captain:
        condition: service_healthy
    volumes:
      - test-home:/home/ubuntu
      - captain-tmux:/run/captain-tmux
      - workspace-tmux:/run/workspace-tmux
    environment:
      - VOICE_TOKEN=test-token-for-ci
      - OPENAI_API_KEY=${OPENAI_API_KEY:-sk-test-dummy}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-sk-ant-test-dummy}
      - CAPTAIN_TMUX_SOCKET=/run/captain-tmux/default
      - WORKSPACE_TMUX_SOCKET=/run/workspace-tmux/default
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:3000/ || exit 1"]
      interval: 3s
      timeout: 3s
      retries: 30
      start_period: 5s

  pane-monitor:
    build:
      context: src/pane-monitor
    pid: "service:workspace"
    depends_on:
      captain:
        condition: service_healthy
    volumes:
      - captain-tmux:/run/captain-tmux
      - workspace-tmux:/run/workspace-tmux
    environment:
      - CAPTAIN_TMUX_SOCKET=/run/captain-tmux/default
      - WORKSPACE_TMUX_SOCKET=/run/workspace-tmux/default

  test-runner:
    build:
      context: .
      dockerfile: tests/Dockerfile.test
    network_mode: "service:workspace"
    pid: "service:workspace"
    depends_on:
      voice-server:
        condition: service_healthy
      pane-monitor:
        condition: service_started
    volumes:
      - test-home:/home/ubuntu
      - captain-tmux:/run/captain-tmux
      - workspace-tmux:/run/workspace-tmux
    environment:
      - VOICE_TOKEN=test-token-for-ci
      - TEST_INTEGRATION=1
      - TEST_CAPTAIN=${TEST_CAPTAIN:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-sk-test-dummy}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-sk-ant-test-dummy}
      - CAPTAIN_TMUX_SOCKET=/run/captain-tmux/default
      - WORKSPACE_TMUX_SOCKET=/run/workspace-tmux/default

volumes:
  captain-tmux:
  workspace-tmux:
  test-home:
