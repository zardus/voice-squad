# Test stack: reuses real images with a lightweight test-runner.
#
# Usage (via test.sh):
#   docker compose -p voice-squad-test -f docker-compose.test.yml run --build --rm test-runner
#
# All services share the workspace PID/network namespace so localhost:3000,
# pgrep, and tmux commands work transparently from the test-runner.

services:
  workspace:
    build:
      context: src
      dockerfile: Dockerfile.workspace
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        set -e
        sudo mkdir -p /run/tmux && sudo chown ubuntu:ubuntu /run/tmux && sudo chmod 755 /run/tmux
        mkdir -p /home/ubuntu/captain/archive/summaries
        mkdir -p /home/ubuntu/captain/task-definitions/pending
        mkdir -p /home/ubuntu/captain/task-definitions/archived
        # Stub pane-monitor so restart-idle-monitor test can start it via tmux
        printf '#!/bin/bash\necho "pane-monitor stub running"\nwhile true; do sleep 60; done\n' | sudo tee /opt/squad/pane-monitor.sh >/dev/null
        sudo chmod +x /opt/squad/pane-monitor.sh
        # Copy captain instructions so restart-captain.sh can find them
        cp /opt/squad/captain/instructions.md /home/ubuntu/captain/CLAUDE.md
        # Write ~/env so restart-captain.sh can source API keys
        printf 'OPENAI_API_KEY="%s"\nANTHROPIC_API_KEY="%s"\n' "$$OPENAI_API_KEY" "$$ANTHROPIC_API_KEY" > /home/ubuntu/env
        echo "$$VOICE_TOKEN" > /home/ubuntu/.voice-token
        tmux new-session -d -s captain -c /home/ubuntu
        exec sleep infinity
    volumes:
      - test-home:/home/ubuntu
      - tmux-socket:/run/tmux
    environment:
      - VOICE_TOKEN=test-token-for-ci
      - OPENAI_API_KEY=${OPENAI_API_KEY:-sk-test-dummy}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-sk-ant-test-dummy}
      - TMUX_TMPDIR=/run/tmux
    healthcheck:
      test: ["CMD-SHELL", "tmux has-session -t captain 2>/dev/null"]
      interval: 2s
      timeout: 3s
      retries: 30
      start_period: 3s

  voice-server:
    build:
      context: src
      dockerfile: Dockerfile.voice
    network_mode: "service:workspace"
    pid: "service:workspace"
    depends_on:
      workspace:
        condition: service_healthy
    volumes:
      - test-home:/home/ubuntu
      - tmux-socket:/run/tmux
    environment:
      - VOICE_TOKEN=test-token-for-ci
      - OPENAI_API_KEY=${OPENAI_API_KEY:-sk-test-dummy}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-sk-ant-test-dummy}
      - TMUX_TMPDIR=/run/tmux
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:3000/ || exit 1"]
      interval: 3s
      timeout: 3s
      retries: 30
      start_period: 5s

  pane-monitor:
    build:
      context: src
      dockerfile: Dockerfile.pane-monitor
    pid: "service:workspace"
    depends_on:
      workspace:
        condition: service_healthy
    volumes:
      - tmux-socket:/run/tmux
    environment:
      - TMUX_TMPDIR=/run/tmux

  test-runner:
    build:
      context: .
      dockerfile: tests/Dockerfile.test
    network_mode: "service:workspace"
    pid: "service:workspace"
    depends_on:
      voice-server:
        condition: service_healthy
      pane-monitor:
        condition: service_started
    volumes:
      - test-home:/home/ubuntu
      - tmux-socket:/run/tmux
    environment:
      - VOICE_TOKEN=test-token-for-ci
      - TEST_INTEGRATION=1
      - TEST_CAPTAIN=${TEST_CAPTAIN:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-sk-test-dummy}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-sk-ant-test-dummy}
      - TMUX_TMPDIR=/run/tmux

volumes:
  tmux-socket:
  test-home:
